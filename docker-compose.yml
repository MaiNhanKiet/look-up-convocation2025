version: '3.9'

services:
  # üëë 1. NGINX PROXY MANAGER (C·ªïng v√†o duy nh·∫•t)
  # ƒê√¢y l√† d·ªãch v·ª• DUY NH·∫§T ƒë∆∞·ª£c truy c·∫≠p t·ª´ Internet.
  app:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: convocation2025_npm
    restart: unless-stopped
    environment:
      TZ: 'Australia/Brisbane' # B·∫°n c√≥ th·ªÉ ƒë·ªïi m√∫i gi·ªù n·∫øu mu·ªën
    ports:
      - '80:80' # Cho HTTP (b·∫Øt bu·ªôc)
      - '81:81' # Cho giao di·ªán Admin (n√™n ƒë√≥ng b·∫±ng t∆∞·ªùng l·ª≠a)
      - '443:443' # Cho HTTPS (b·∫Øt bu·ªôc)
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    # Th√™m NPM v√†o m·∫°ng 'convocation2025' ƒë·ªÉ n√≥ "th·∫•y" ƒë∆∞·ª£c backend/frontend
    networks:
      - convocation2025
    depends_on:
      - backend
      - frontend

  # üçÉ 2. MONGODB DATABASE
  # KH√îNG BAO GI·ªú ƒë∆∞·ª£c l·ªô 'ports' c·ªßa database ra ngo√†i.
  mongo:
    image: mongo:latest
    container_name: convocation2025_mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: kietmn
      MONGO_INITDB_ROOT_PASSWORD: kietdeptrai123
    # KH√îNG C·∫¶N 'ports'. Backend s·∫Ω k·∫øt n·ªëi qua t√™n container.
    volumes:
      - mongo_data:/data/db
    networks:
      - convocation2025

  # üõ† 3. BACKEND SERVICE (Node + TypeScript)
  backend:
    build:
      context: ./back-end
      dockerfile: Dockerfile
    container_name: convocation2025_backend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=8080 # ƒê√¢y l√† c·ªïng ch·∫°y B√äN TRONG container
      # K·∫øt n·ªëi database b·∫±ng T√äN CONTAINER (convocation2025_mongo)
      - DATABASE_URL=mongodb://kietmn:kietdeptrai123@convocation2025_mongo:27017/convocation2025?authSource=admin
      - DB_NAME=convocation2025
      - DB_BACHELOR_COLLECTION=bachelors
      # C·∫≠p nh·∫≠t CORS sau khi c√≥ domain
      - CORS_ORIGIN=https://www.srofptuhcm.com,https://srofptuhcm.com
    # KH√îNG C·∫¶N 'ports'. NPM s·∫Ω truy c·∫≠p n·ªôi b·ªô qua port 8080.
    depends_on:
      - mongo
    networks:
      - convocation2025

  # üåê 4. FRONTEND SERVICE (Next.js)
  frontend:
    build:
      context: ./front-end
      dockerfile: Dockerfile
      args:
        # Truy·ªÅn bi·∫øn n√†y V√ÄO L√öC BUILD
        - NEXT_PUBLIC_API_URL=https://api.srofptuhcm.com
    container_name: convocation2025_frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      # PORT n√†y cho Next.js server (ƒë√£ EXPOSE 3002 trong Dockerfile)
      - PORT=3002
    # KH√îNG C·∫¶N 'ports'. NPM s·∫Ω truy c·∫≠p n·ªôi b·ªô qua port 3002.
    depends_on:
      - backend
    networks:
      - convocation2025

# üì¶ N∆°i l∆∞u tr·ªØ data c·ªßa database (persistent data)
volumes:
  mongo_data:

# üåê M·∫°ng n·ªôi b·ªô ƒë·ªÉ c√°c container "n√≥i chuy·ªán" v·ªõi nhau
networks:
  convocation2025:
    driver: bridge
